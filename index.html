<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Safe Zone Map Editor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }

        canvas {
            border: 2px solid #555;
            cursor: crosshair;
            display: block;
            margin-top: 10px;
        }

        #controls {
            margin-bottom: 10px;
        }

        #safeZones {
            margin-top: 15px;
            white-space: pre;
            background: #f4f4f4;
            padding: 10px;
            border: 1px solid #ccc;
        }
    </style>
</head>

<body>

    <div id="controls">
        <label>Upload Map Image: <input type="file" id="mapUploader" accept="image/*" /></label><br><br>
        <button onclick="toggleRectangles()">Toggle Rectangles</button>
        <button onclick="undoLastRectangle()">Undo Last Rectangle</button>
        <button onclick="clearRectangles()">Clear All Rectangles</button>
    </div>

    <canvas id="mapCanvas"></canvas>

    <h3>Safe Zone Data (x, y, width, height):</h3>
    <div id="safeZones"></div>
    <br><br>
    <label>Export File Name: <input type="text" id="exportFileName" value="safezones" /></label>
    <button onclick="exportSafeZones()">Export Safe Zones</button>

    <script>
        const canvas = document.getElementById('mapCanvas');
        const ctx = canvas.getContext('2d');
        const mapUploader = document.getElementById('mapUploader');
        const safeZonesDisplay = document.getElementById('safeZones');

        let mapImage = new Image();
        let imageLoaded = false;
        let showRectangles = true;
        let safeZones = [];

        let isDrawing = false;
        let startX, startY;
        let currentRect = null;

        mapUploader.addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (event) {
                mapImage.onload = () => {
                    canvas.width = mapImage.width;
                    canvas.height = mapImage.height;
                    imageLoaded = true;
                    safeZones = [];
                    redraw();
                };
                mapImage.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        canvas.addEventListener('mousedown', function (e) {
            if (!imageLoaded) return;
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            startX = e.clientX - rect.left;
            startY = e.clientY - rect.top;
        });

        canvas.addEventListener('mousemove', function (e) {
            if (!isDrawing || !imageLoaded) return;
            const rect = canvas.getBoundingClientRect();
            const currentX = e.clientX - rect.left;
            const currentY = e.clientY - rect.top;

            currentRect = {
                x: Math.min(startX, currentX),
                y: Math.min(startY, currentY),
                width: Math.abs(currentX - startX),
                height: Math.abs(currentY - startY),
            };
            redraw();
        });

        canvas.addEventListener('mouseup', function () {
            if (isDrawing && currentRect && imageLoaded) {
                safeZones.push(currentRect);
                updateSafeZoneDisplay();
                currentRect = null;
                isDrawing = false;
                redraw();
            }
        });

        function redraw() {
            if (!imageLoaded) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(mapImage, 0, 0, canvas.width, canvas.height);

            if (showRectangles) {
                ctx.strokeStyle = 'limegreen';
                ctx.lineWidth = 2;
                safeZones.forEach(rect => {
                    ctx.strokeRect(rect.x, rect.y, rect.width, rect.height);
                });

                if (currentRect) {
                    ctx.strokeStyle = 'blue';
                    ctx.strokeRect(currentRect.x, currentRect.y, currentRect.width, currentRect.height);
                }
            }
        }

        function updateSafeZoneDisplay() {
            safeZonesDisplay.textContent = safeZones.map(r => {
                return `x: ${Math.round(r.x)}, y: ${Math.round(r.y)}, width: ${Math.round(r.width)}, height: ${Math.round(r.height)}`;
            }).join('\n');
        }

        function toggleRectangles() {
            showRectangles = !showRectangles;
            redraw();
        }

        function clearRectangles() {
            safeZones = [];
            updateSafeZoneDisplay();
            redraw();
        }
        function undoLastRectangle() {
            if (safeZones.length > 0) {
                safeZones.pop();
                updateSafeZoneDisplay();
                redraw();
            }
        }
        function exportSafeZones() {
            if (safeZones.length === 0) {
                alert("No safe zones to export.");
                return;
            }

            const fileName = document.getElementById("exportFileName").value.trim() || "safezones";
            const dataStr = JSON.stringify(safeZones, null, 2); // pretty JSON
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);

            const link = document.createElement("a");
            link.href = url;
            link.download = fileName + ".json";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }


    </script>

</body>

</html>